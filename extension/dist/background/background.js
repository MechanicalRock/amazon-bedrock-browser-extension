import{c as T,a as L,b as F,d as N,f as h,p as R,e as M,g as k,P as b,_ as g,h as K,i as w,j as O}from"../assets/tabs-4887e7c1.js";import{A as _,E as I,L as G}from"../assets/constants-0cd32530.js";var E=k(),s=new Map,u=new Map,x=new Map,C=(e,i)=>(u.set(e,(u.get(e)||new Set).add(i)),()=>{const n=u.get(e);n!=null&&n.delete(i)&&(n==null?void 0:n.size)===0&&u.delete(e)}),S=(e,i)=>{x.set(e,(x.get(e)||new Set).add(i))},p=e=>({withFingerprint:i=>{const n=a=>({and:()=>a}),o={aboutIncomingMessage:a=>{const t=s.get(e);return b.toExtensionContext(t.port,{status:"incoming",message:a}),n(o)},aboutSuccessfulDelivery:a=>{const t=s.get(e);return b.toExtensionContext(t.port,{status:"delivered",receipt:a}),n(o)},aboutMessageUndeliverability:(a,t)=>{const r=s.get(e);return(r==null?void 0:r.fingerprint)===i&&b.toExtensionContext(r.port,{status:"undeliverable",resolvedDestination:a,message:t}),n(o)},whenDeliverableTo:a=>{const t=()=>{const r=s.get(e);if((r==null?void 0:r.fingerprint)===i&&s.has(a))return b.toExtensionContext(r.port,{status:"deliverable",deliverableTo:a}),!0};if(!t()){const r=C(a,t);S(i,r)}return n(o)},aboutSessionEnded:a=>{const t=s.get(e);return(t==null?void 0:t.fingerprint)===i&&b.toExtensionContext(t.port,{status:"terminated",fingerprint:a}),n(o)}};return o}}),U=T(),y=L("background",e=>{var i;if(e.origin.context==="background"&&["content-script","devtools "].includes(e.destination.context)&&!e.destination.tabId)throw new TypeError("When sending messages from background page, use @tabId syntax to target specific tab");const n=h(g(g({},e.origin),e.origin.context==="window"&&{context:"content-script"})),o=h(K(g(g({},e.destination),e.destination.context==="window"&&{context:"content-script"}),{tabId:e.destination.tabId||e.origin.tabId}));e.destination.tabId=null,e.destination.frameId=null;const a=()=>s.get(o),t=()=>s.get(n),r=()=>{var c;p(o).withFingerprint(a().fingerprint).aboutIncomingMessage(e);const v={message:e,to:a().fingerprint,from:{endpointId:n,fingerprint:(c=t())==null?void 0:c.fingerprint}};e.messageType==="message"&&E.add(v),e.messageType==="reply"&&E.remove(e.messageID),t()&&p(n).withFingerprint(t().fingerprint).aboutSuccessfulDelivery(v)};(i=a())!=null&&i.port?r():e.messageType==="message"&&(e.origin.context==="background"?C(o,r):t()&&p(n).withFingerprint(t().fingerprint).aboutMessageUndeliverability(o,e).and().whenDeliverableTo(o))},e=>{const i=h(g(g({},e.origin),e.origin.context==="window"&&{context:"content-script"})),n=s.get(i),o={message:e,to:U,from:{endpointId:i,fingerprint:n.fingerprint}};p(i).withFingerprint(n.fingerprint).aboutSuccessfulDelivery(o)});F.runtime.onConnect.addListener(e=>{var i;const n=N(e.name);if(!n)return;n.endpointName||(n.endpointName=h({context:"content-script",tabId:e.sender.tab.id,frameId:e.sender.frameId}));const{tabId:o,frameId:a}=R(n.endpointName);s.set(n.endpointName,{fingerprint:n.fingerprint,port:e}),(i=u.get(n.endpointName))==null||i.forEach(t=>t()),u.delete(n.endpointName),S(n.fingerprint,()=>{const t=E.entries().filter(r=>r.to===n.fingerprint);E.remove(t),t.forEach(r=>{r.from.endpointId==="background"?y.endTransaction(r.message.transactionId):p(r.from.endpointId).withFingerprint(r.from.fingerprint).aboutSessionEnded(n.fingerprint)})}),e.onDisconnect.addListener(()=>{var t,r;((t=s.get(n.endpointName))==null?void 0:t.fingerprint)===n.fingerprint&&s.delete(n.endpointName),(r=x.get(n.fingerprint))==null||r.forEach(c=>c()),x.delete(n.fingerprint)}),e.onMessage.addListener(t=>{var r,c;if(t.type==="sync"){const v=[...s.values()].map(d=>d.fingerprint),D=t.pendingResponses.filter(d=>v.includes(d.to));E.add(...D),t.pendingResponses.filter(d=>!v.includes(d.to)).forEach(d=>p(n.endpointName).withFingerprint(n.fingerprint).aboutSessionEnded(d.to)),t.pendingDeliveries.forEach(d=>p(n.endpointName).withFingerprint(n.fingerprint).whenDeliverableTo(d));return}t.type==="deliver"&&((c=(r=t.message)==null?void 0:r.origin)!=null&&c.context)&&(t.message.origin.tabId=o,t.message.origin.frameId=a,y.handleMessage(t.message))})});var{sendMessage:m,onMessage:W}=y;M(y);const l={get:async(e,i)=>{const n=`${G}${e}`,o=await w.storage.local.get(n);return n in o?o[e]??i:i}};w.runtime.onInstalled.addListener(()=>{console.info("Extension installed")});let f=0;w.commands.onCommand.addListener(e=>{(async()=>{if(e==="translate"){console.info("Hotkey has triggered a translation.");const i=await O(),n={creds:{region:await l.get(_.AWS_REGION,""),credentials:{accessKeyId:await l.get(_.AWS_ACCESS_KEY_ID,""),secretAccessKey:await l.get(_.AWS_SECRET_ACCESS_KEY,"")}},langs:{source:await l.get(I.DEFAULT_SOURCE_LANG,"auto"),target:await l.get(I.DEFAULT_TARGET_LANG,"en")},tabId:i,cachingEnabled:await l.get(I.CACHING_ENABLED,"false")==="true",bedrockEnabled:await l.get(I.BEDROCK_ENABLED,"false")==="true"};m("translate",n,"content-script@"+i)}})()});w.tabs.onActivated.addListener(({tabId:e})=>{if(console.debug("tab activated",e,f),!f){f=e;return}A(f).then(i=>{f=e,console.info("previous tab",i),m("tab-prev",{title:i.title},"content-script@"+e)}).catch(()=>{})});const A=async e=>w.tabs.get(e);W("get-current-tab",async()=>{try{const e=await A(f);return{title:`${(e==null?void 0:e.id)??""}`}}catch{return{title:""}}});
